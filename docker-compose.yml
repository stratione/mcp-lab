services:
  user-api:
    build: ./user-api
    ports:
      - "8001:8001"
    volumes:
      - user-api-data:/app/data
    networks:
      - mcp-lab-net
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8001/health')\""]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  gitea:
    image: gitea/gitea:latest
    ports:
      - "3000:3000"
      - "2222:22"
    environment:
      - GITEA__server__ROOT_URL=http://localhost:3000
      - GITEA__server__HTTP_PORT=3000
      - GITEA__database__DB_TYPE=sqlite3
      - GITEA__security__INSTALL_LOCK=true
      - GITEA__service__DISABLE_REGISTRATION=false
    volumes:
      - gitea-data:/data
    networks:
      - mcp-lab-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/v1/version"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped

  registry-dev:
    image: registry:2
    ports:
      - "5001:5000"
    volumes:
      - registry-dev-data:/var/lib/registry
    networks:
      - mcp-lab-net
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5000/v2/"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  registry-prod:
    image: registry:2
    ports:
      - "5002:5000"
    volumes:
      - registry-prod-data:/var/lib/registry
    networks:
      - mcp-lab-net
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5000/v2/"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  promotion-service:
    build: ./promotion-service
    ports:
      - "8002:8002"
    environment:
      - USER_API_URL=http://user-api:8001
      - DEV_REGISTRY_URL=http://registry-dev:5000
      - PROD_REGISTRY_URL=http://registry-prod:5000
    volumes:
      - promotion-data:/app/data
    networks:
      - mcp-lab-net
    depends_on:
      user-api:
        condition: service_healthy
      registry-dev:
        condition: service_healthy
      registry-prod:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8002/health')\""]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  mcp-user:
    build: ./mcp-server
    profiles: ["user"]
    ports:
      - "8003:8003"
    environment:
      - MCP_TRANSPORT=streamable-http
      - USER_API_URL=http://user-api:8001
    command: ["python", "-m", "mcp_server.server_user"]
    networks:
      - mcp-lab-net
    depends_on:
      user-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,json; r=urllib.request.urlopen(urllib.request.Request('http://localhost:8003/mcp',data=json.dumps({'jsonrpc':'2.0','id':0,'method':'initialize','params':{'protocolVersion':'2024-11-05','capabilities':{},'clientInfo':{'name':'hc','version':'1'}}}).encode(),headers={'Content-Type':'application/json','Accept':'application/json, text/event-stream'})); r.read()\""]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  mcp-gitea:
    build: ./mcp-server
    profiles: ["gitea"]
    ports:
      - "8004:8004"
    environment:
      - MCP_TRANSPORT=streamable-http
      - GITEA_URL=http://gitea:3000
      - GITEA_TOKEN=${GITEA_TOKEN:-}
    command: ["python", "-m", "mcp_server.server_gitea"]
    networks:
      - mcp-lab-net
    depends_on:
      gitea:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,json; r=urllib.request.urlopen(urllib.request.Request('http://localhost:8004/mcp',data=json.dumps({'jsonrpc':'2.0','id':0,'method':'initialize','params':{'protocolVersion':'2024-11-05','capabilities':{},'clientInfo':{'name':'hc','version':'1'}}}).encode(),headers={'Content-Type':'application/json','Accept':'application/json, text/event-stream'})); r.read()\""]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  mcp-registry:
    build: ./mcp-server
    profiles: ["registry"]
    ports:
      - "8005:8005"
    environment:
      - MCP_TRANSPORT=streamable-http
      - DEV_REGISTRY_URL=http://registry-dev:5000
      - PROD_REGISTRY_URL=http://registry-prod:5000
    command: ["python", "-m", "mcp_server.server_registry"]
    networks:
      - mcp-lab-net
    depends_on:
      registry-dev:
        condition: service_healthy
      registry-prod:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,json; r=urllib.request.urlopen(urllib.request.Request('http://localhost:8005/mcp',data=json.dumps({'jsonrpc':'2.0','id':0,'method':'initialize','params':{'protocolVersion':'2024-11-05','capabilities':{},'clientInfo':{'name':'hc','version':'1'}}}).encode(),headers={'Content-Type':'application/json','Accept':'application/json, text/event-stream'})); r.read()\""]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  mcp-promotion:
    build: ./mcp-server
    profiles: ["promotion"]
    ports:
      - "8006:8006"
    environment:
      - MCP_TRANSPORT=streamable-http
      - PROMOTION_SERVICE_URL=http://promotion-service:8002
    command: ["python", "-m", "mcp_server.server_promotion"]
    networks:
      - mcp-lab-net
    depends_on:
      promotion-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request,json; r=urllib.request.urlopen(urllib.request.Request('http://localhost:8006/mcp',data=json.dumps({'jsonrpc':'2.0','id':0,'method':'initialize','params':{'protocolVersion':'2024-11-05','capabilities':{},'clientInfo':{'name':'hc','version':'1'}}}).encode(),headers={'Content-Type':'application/json','Accept':'application/json, text/event-stream'})); r.read()\""]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  chat-ui:
    build: ./chat-ui
    ports:
      - "3001:3001"
    env_file:
      - .env
      - .env.secrets
    environment:
      - MCP_SERVERS=http://mcp-user:8003,http://mcp-gitea:8004,http://mcp-registry:8005,http://mcp-promotion:8006
      - OLLAMA_URL=${OLLAMA_URL:-http://host.containers.internal:11434}
      - CHAT_DATA_DIR=/app/data
      - CONTAINER_ENGINE=${CONTAINER_ENGINE:-docker}
    volumes:
      - chat-ui-data:/app/data
    networks:
      - mcp-lab-net
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:3001/health')\""]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  bootstrap:
    image: alpine:3.19
    volumes:
      - ./scripts:/scripts:ro
    networks:
      - mcp-lab-net
    depends_on:
      user-api:
        condition: service_healthy
      gitea:
        condition: service_healthy
      registry-dev:
        condition: service_healthy
      registry-prod:
        condition: service_healthy
    entrypoint: ["/bin/sh", "/scripts/bootstrap.sh"]
    restart: "no"

volumes:
  user-api-data:
  gitea-data:
  registry-dev-data:
  registry-prod-data:
  promotion-data:
  chat-ui-data:

networks:
  mcp-lab-net:
    driver: bridge
